#!/usr/bin/env sh

# Tag and push a release.

set -e

set -a
[ -f .env ] && . .env
set +a

if [ -z "$S3_ID" ]; then
    echo "Need to set S3_ID"
    exit 1
fi

if [ -z "$S3_SECRET" ]; then
    echo "Need to set S3_SECRET"
    exit 1
fi

# Make sure we’re on the master branch.

(git branch | grep -q '* master') || {
  echo "Only release from the master branch."
  exit 1
}

# Make sure we’re in the project root.

cd $(dirname "$0")/..

# Build the site.

docker-compose run jekyll jekyll build

# Deploy it.

docker-compose run -e S3_ID=$S3_ID -e S3_SECRET=$S3_SECRET s3_website
